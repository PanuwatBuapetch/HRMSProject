@page "/executive"
@using AntDesign
@using Datamodels.Hrms
@using Hrms_project.Components.Pages.Executive
@implements IAsyncDisposable

<PageTitle>จัดการข้อมูลผู้บริหาร | HRMS</PageTitle>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-primary m-0">
            <Icon Type="team" Theme="IconThemeType.Outline" /> ระบบจัดการผู้บริหาร
        </h3>
        <Button Type="@ButtonType.Primary" Icon="plus" OnClick="OpenSelectionModal" Size="@ButtonSize.Large">
            แต่งตั้งผู้บริหาร
        </Button>
    </div>

    <div class="card shadow-sm border-0">
        @* ใช้ Ant Design Table *@
        <Table TItem="VManagementDetail"
               DataSource="@ExecutivesList"
               Loading="@IsLoading"
               Bordered
               PaginationPosition="Boot">
            <PropertyColumn Property="c => c.StaffId" Title="รหัสพนักงาน" Sortable />
            <PropertyColumn Property="c => c.StaffNameThai" Title="ชื่อ-นามสกุล" Sortable />
            <PropertyColumn Property="c => c.AdminNameThai" Title="ตำแหน่งบริหาร" />
            <Column TData="string" Title="สถานะ" Align="ColumnAlign.Center">
                @if (context.Isactive == "Y")
                {
                    <Tag Color="Green">กำลังทำงาน</Tag>
                }
                else
                {
                    <Tag Color="Red">ปิดใช้งาน</Tag>
                }
            </Column>
            <ActionColumn Title="จัดการ" Align="ColumnAlign.Center">
                <Space>
                    <SpaceItem>
                        <Tooltip Title="แก้ไขข้อมูล">
                            <Button Icon="edit" Shape="@ButtonShape.Circle" OnClick="() => EditExecutive(context)" />
                        </Tooltip>
                    </SpaceItem>
                    <SpaceItem>
                        <Tooltip Title="ถอดถอนตำแหน่ง">
                            <Button Icon="delete" Danger Shape="@ButtonShape.Circle" OnClick="() => DeleteExecutive(context)" />
                        </Tooltip>
                    </SpaceItem>
                </Space>
            </ActionColumn>
        </Table>
    </div>
</div>

@* Modal 1: เลือกพนักงาน *@
<Modal Title="ค้นหาพนักงานเพื่อแต่งตั้ง"
       @bind-Visible="@ShowSelectionModal"
       Footer="null"
       Width="800">
    <div class="d-flex mb-3 gap-2">
        <Search Placeholder="พิมพ์ชื่อหรือรหัสพนักงาน..."
                @bind-Value="@PersonnelSearchTerm"
                OnSearch="LoadPersonnelForSelection"
                EnterButton="true" />
    </div>
    <Table TItem="Personnel" DataSource="@PersonnelList" Size="@TableSize.Small" ScrollY="300px">
        <PropertyColumn Property="c => c.EmployeeId" Title="ID" Width="100px" />
        <PropertyColumn Property="c => c.FullNameThai" Title="ชื่อ-นามสกุล" />
        <ActionColumn Align="ColumnAlign.Right">
            <Button Type="@ButtonType.Link" OnClick="() => SelectEmployeeForManagement(context)">เลือกคนนี้</Button>
        </ActionColumn>
    </Table>
</Modal>

@* Modal 2: ฟอร์ม CRUD *@
<Modal Title="@(IsEditing ? "แก้ไขข้อมูลผู้บริหาร" : "แต่งตั้งตำแหน่งบริหาร")"
       @bind-Visible="@ShowManagementForm"
       OnOk="HandleSubmit"
       OkText="@("บันทึกข้อมูล")"
       CancelText="@("ยกเลิก")"
       ConfirmLoading="@IsSubmitting">
    <Form Model="@CurrentManagement" Layout="@FormLayout.Vertical">
        <FormItem Label="ชื่อผู้บริหาร">
            <Input Value="@SelectedEmployeeName" Disabled />
        </FormItem>
        <FormItem Label="รหัสตำแหน่งบริหาร (Management Position ID)">
            <Input @bind-Value="@context.ManagementPositionId" MaxLength="2" Placeholder="เช่น 01, 02" />
        </FormItem>
        <FormItem Label="สถานะการทำงาน">
            <Select @bind-Value="@context.Isactive" TItem="string" TItemValue="string">
                <SelectOption TItem="string" TItemValue="string" Value="@("Y")" Label="เปิดใช้งาน (Active)" />
                <SelectOption TItem="string" TItemValue="string" Value="@("N")" Label="ปิดใช้งาน (Inactive)" />
            </Select>
        </FormItem>
    </Form>
</Modal>