@page "/organization"
@using Datamodels.Hrms
@using HrmsSolution.Service
@using AntDesign
@using CurrieTechnologies.Razor.SweetAlert2
@inject IOrganizationService OrganizationService
@inject IVEmployeeDetailsService EmployeeService
@inject JsonLocalizationService locallizer
@inject MessageService MessageService
@inject ModalService ModalService
@inject NavigationManager NavigationManager
@inject SweetAlertService Swal
@rendermode InteractiveServer

@using static AntDesign.IconType
@using static AntDesign.ButtonType
@using static AntDesign.AvatarSize
@using static AntDesign.TagColor
@using static AntDesign.SpinSize

<PageTitle>@locallizer["โครงสร้างองค์กรและบุคลากร"]</PageTitle>

<div class="container-fluid px-4 py-3">
    @if (IsLoading)
    {
        <div class="spinner-container d-flex justify-content-center align-items-center" style="height: 80vh;">
            <Spin Size="SpinSize.Large" Tip="กำลังโหลดข้อมูล..." />
        </div>
    }
    else
    {
        @* --- Header Section --- *@
        <div class="d-flex justify-content-between align-items-center mb-4 bg-white p-3 rounded shadow-sm">
            <div class="title">
                <h3 class="fw-bold mb-1">@locallizer["โครงสร้างองค์กร"]</h3>
                <Breadcrumb>
                    <BreadcrumbItem Href=""><Icon Type="home" /> <span>@locallizer["หน้าแรก"]</span></BreadcrumbItem>
                    <BreadcrumbItem><Icon Type="apartment" /> <span>@locallizer["โครงสร้างองค์กร"]</span></BreadcrumbItem>
                </Breadcrumb>
            </div>
            <div class="header-actions gap-2 d-flex">
                <Button Type="Primary" Icon="plus-circle" OnClick="() => _visibleDivision = true">
                    @locallizer["เพิ่มสำนัก/กอง"]
                </Button>
                @if (CurrentDivision != null)
                {
                    <Button Type="ButtonType.Default" Icon="folder-add" OnClick="() => OpenAddDepartmentModal()">
                        @locallizer["เพิ่มฝ่าย (ในสังกัดนี้)"]
                    </Button>
                }
            </div>
        </div>

        @* --- Navigation/Search --- *@
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-body">
                <div class="row align-items-center g-3">
                    <div class="col-12 col-md-6">
                        <div class="input-group">
                            <Input Placeholder="@($"{locallizer["ค้นหาฝ่ายภายใน"]} {(CurrentDivision != null ? CurrentDivision.DivisionNameThai : "")}")"
                                   @bind-Value="searchTerm" OnInput="HandleSearch" />
                            <Button OnClick="ClearData">@locallizer["ล้าง"]</Button>
                        </div>
                    </div>
                    <div class="col-12 col-md-6 text-md-end">
                        <div class="btn-group">
                            <Button Disabled="@(currentIndex <= 0 || IsLoadingDATA)" OnClick="LoadPreviousData" Icon="left">@locallizer["ย้อนกลับ"]</Button>
                            <Button Disabled="@(currentIndex >= ShowDivisions.Count - 1 || IsLoadingDATA)" OnClick="LoadNextData">
                                @locallizer["ถัดไป"] <Icon Type="right" />
                            </Button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @* --- Content Area --- *@
        <div class="row justify-content-center">
            @if (CurrentDivision != null)
            {
                <div class="col-12 text-center mb-4">
                    <Card Bordered Style="border-left: 5px solid #1890ff; max-width: 600px; margin: 0 auto;" Class="shadow-sm">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center gap-3">
                                <Avatar Icon="bank" Size="AvatarSize.Large" Style="background-color: #1890ff;" />
                                <div class="text-start">
                                    <h4 class="mb-0 fw-bold">@CurrentDivision.DivisionNameThai</h4>
                                    <div style="font-size: 12px; color: #8c8c8c;">@CurrentDivision.DivisionNameEng</div>
                                </div>
                            </div>
                            <div class="d-flex gap-1">
                                <Tooltip Title="@locallizer["แก้ไขสำนัก/กอง"]">
                                    <Button Type="ButtonType.Text" Shape="@ButtonShape.Circle" Icon="edit" OnClick="() => OpenEditDivision(CurrentDivision)" />
                                </Tooltip>
                                <Tooltip Title="@locallizer["ลบสำนัก/กอง"]">
                                    <Button Type="ButtonType.Text" Danger Shape="@ButtonShape.Circle" Icon="delete" OnClick="() => HandleDeleteDivision(CurrentDivision)" />
                                </Tooltip>
                            </div>
                        </div>
                    </Card>
                </div>
            }

            @if (IsLoadingDATA)
            {
                <div class="col-12 text-center p-5"><Spin Tip="กำลังโหลดรายชื่อฝ่าย..." /></div>
            }
            else
            {
                <div class="org-grid-wrapper w-100">
                    @if (FilteredDepartments != null && FilteredDepartments.Any())
                    {
                        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                            @foreach (var dept in FilteredDepartments.Skip(currentPage * pageSize).Take(pageSize))
                            {
                                <div class="col">
                                    <Card Title="@dept.DeptNameThai" Class="h-100 shadow-sm dept-card">
                                        <Extra>
                                            <div class="d-flex align-items-center gap-1">
                                                <Tag Color="Blue">@dept.DeptId</Tag>
                                                <Dropdown>
                                                    <Overlay>
                                                        <Menu>
                                                            <MenuItem OnClick="() => OpenEditDepartment(dept)">
                                                                <Icon Type="edit" /> @locallizer["แก้ไขข้อมูลฝ่าย"]
                                                            </MenuItem>
                                                            <MenuItem OnClick="() => NavigateToAddEmployee(dept)">
                                                                <Icon Type="user-add" /> @locallizer["เพิ่มบุคลากรใหม่"]
                                                            </MenuItem>
                                                            <MenuDivider />
                                                            <MenuItem OnClick="() => HandleDeleteDepartment(dept)">
                                                                <Icon Type="delete" /> @locallizer["ลบฝ่าย"]
                                                            </MenuItem>
                                                        </Menu>
                                                    </Overlay>
                                                    <ChildContent>
                                                        <Button Type="ButtonType.Text" Shape="@ButtonShape.Circle" Icon="more" />
                                                    </ChildContent>
                                                </Dropdown>
                                            </div>
                                        </Extra>
                                        <Body>
                                            <div class="mb-2"><span style="font-size: 12px; color: #8c8c8c;">@dept.DeptNameEng</span></div>

                                            @* --- Employee Section (Click to Manage) --- *@
                                            <div class="employee-section mb-3 p-2 rounded" style="background-color: #f9f9f9; cursor: pointer;" 
                                                 @onclick="() => OpenManageEmployeesModal(dept)">
                                                @{
                                                    var deptEmps = allEmployees.Where(e => !string.IsNullOrEmpty(e.DeptId) && string.Equals(e.DeptId.Trim(), dept.DeptId.Trim(), StringComparison.OrdinalIgnoreCase)).ToList();
                                                }
                                                <div class="d-flex align-items-center justify-content-between">
                                                    <div class="d-flex align-items-center">
                                                        @if (deptEmps.Any())
                                                        {
                                                            <AvatarGroup>
                                                                @foreach (var emp in deptEmps)
                                                                {
                                                                    <Tooltip Title="@($"{emp.FirstNameThai} {emp.LastNameThai}")">
                                                                        <Avatar Src="@(string.IsNullOrEmpty(emp.PictureUrl) ? "/picture/user.png" : emp.PictureUrl)" Icon="user" Size="AvatarSize.Small" />
                                                                    </Tooltip>
                                                                }
                                                            </AvatarGroup>
                                                            <div class="ms-2"><Tag Color="Cyan">@deptEmps.Count @locallizer["คน"]</Tag></div>
                                                        }
                                                        else
                                                        {
                                                            <div class="d-flex align-items-center opacity-50">
                                                                <Avatar Icon="user" Size="AvatarSize.Small" Style="background-color: #f5f5f5; color: #bfbfbf;" />
                                                                <span class="ms-2 text-muted fst-italic" style="font-size: 12px;">@locallizer["ว่าง (คลิกเพื่อเพิ่ม)"]</span>
                                                            </div>
                                                        }
                                                    </div>
                                                    <div>
                                                        <Icon Type="setting" Theme="IconThemeType.Outline" Style="color: #bfbfbf;" />
                                                    </div>
                                                </div>
                                            </div>

                                            @* --- Work Units --- *@
                                            <div class="mt-2 pt-2 border-top">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="text-secondary" style="font-size: 0.75rem;">@locallizer["กลุ่มงานภายใน"]:</span>
                                                    <Tooltip Title="@locallizer["เพิ่มกลุ่มงาน"]">
                                                        <Button Type="ButtonType.Text" Size="ButtonSize.Small" Icon="plus" Class="text-primary" OnClick="() => OpenAddUnitModal(dept)" />
                                                    </Tooltip>
                                                </div>

                                                <div class="d-flex flex-wrap gap-1 mt-1">
                                                    @{ var myUnits = workUnits.Where(u => u.DeptId?.Trim() == dept.DeptId?.Trim()).ToList(); }
                                                    @if (myUnits.Any())
                                                    {
                                                        @foreach (var u in myUnits)
                                                        {
                                                            <div style="cursor: pointer;" @onclick="() => OpenEditUnit(u, dept)">
                                                                <Tag Color="Purple" Style="font-size: 11px; margin-right:0;" Class="unit-tag">@u.UnitNameThai</Tag>
                                                            </div>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted" style="font-size: 11px;">-</span>
                                                    }
                                                </div>
                                            </div>
                                        </Body>
                                    </Card>
                                </div>
                            }
                        </div>
                        
                        @* Pagination *@
                        @if (FilteredDepartments.Count > pageSize)
                        {
                            <div class="text-center mt-4">
                                <Pagination Simple Current="currentPage + 1" Total="FilteredDepartments.Count" PageSize="pageSize" OnChange="(PaginationEventArgs args) => { currentPage = (int)args.Page - 1; }" />
                                <div class="mt-2 text-muted" style="font-size: 0.8rem;">แสดงข้อมูล @(currentPage * pageSize + 1) - @(Math.Min((currentPage + 1) * pageSize, FilteredDepartments.Count)) จากทั้งหมด @FilteredDepartments.Count</div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center p-5">
                            <Empty Description="@locallizer["ไม่พบข้อมูลฝ่ายในสำนักนี้"]">
                                <Button Type="Primary" OnClick="OpenAddDepartmentModal">@locallizer["เพิ่มฝ่ายใหม่"]</Button>
                            </Empty>
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>

@* --- Modal 1-3: Structure CRUD (Division, Dept, Unit) เหมือนเดิม --- *@
<Modal Title="@(editingDivision.DivisionId == null ? locallizer["เพิ่มสำนัก/กอง"] : locallizer["แก้ไขสำนัก/กอง"])" @bind-Visible="@_visibleDivision" OnOk="HandleSaveDivision" OkText="@locallizer["บันทึก"]" CancelText="@locallizer["ยกเลิก"]">
    <Form Model="@newDivision" Layout="@FormLayout.Vertical">
        <FormItem Label="@locallizer["รหัสสำนัก/กอง"]"><Input @bind-Value="@context.DivisionId" MaxLength="10" Disabled="@(isEditingDivision)" /></FormItem>
        <FormItem Label="@locallizer["ชื่อภาษาไทย"]"><Input @bind-Value="@context.DivisionNameThai" /></FormItem>
        <FormItem Label="@locallizer["ชื่อภาษาอังกฤษ"]"><Input @bind-Value="@context.DivisionNameEng" /></FormItem>
    </Form>
</Modal>

<Modal Title="@(isEditingDept ? locallizer["แก้ไขข้อมูลฝ่าย"] : locallizer["เพิ่มฝ่ายใหม่"])" @bind-Visible="@_visibleEditDept" OnOk="HandleSaveDepartment" OkText="@locallizer["บันทึก"]" CancelText="@locallizer["ยกเลิก"]">
    <Form Model="@editingDept" Layout="@FormLayout.Vertical">
        <FormItem Label="@locallizer["รหัสฝ่าย"]"><Input @bind-Value="@context.DeptId" MaxLength="10" Disabled="@isEditingDept" /></FormItem>
        <FormItem Label="@locallizer["ชื่อฝ่าย (ไทย)"]"><Input @bind-Value="@context.DeptNameThai" /></FormItem>
        <FormItem Label="@locallizer["ชื่อฝ่าย (อังกฤษ)"]"><Input @bind-Value="@context.DeptNameEng" /></FormItem>
    </Form>
</Modal>

<Modal Title="@(isEditingUnit ? locallizer["แก้ไขกลุ่มงาน"] : locallizer["เพิ่มกลุ่มงานใหม่"])" @bind-Visible="@_visibleEditUnit" OnOk="HandleSaveUnit" OkText="@locallizer["บันทึก"]" CancelText="@locallizer["ยกเลิก"]">
    <Form Model="@editingUnit" Layout="@FormLayout.Vertical">
        <FormItem Label="@locallizer["รหัสกลุ่มงาน"]"><Input @bind-Value="@context.UnitId" Placeholder="เช่น IT-DEV" MaxLength="10" Disabled="@isEditingUnit" /></FormItem>
        <FormItem Label="@locallizer["ชื่อกลุ่มงาน (ไทย)"]"><Input @bind-Value="@context.UnitNameThai" /></FormItem>
        <FormItem Label="@locallizer["ชื่อกลุ่มงาน (อังกฤษ)"]"><Input @bind-Value="@context.UnitNameEng" /></FormItem>
        <FormItem Label="@locallizer["สังกัดฝ่าย"]"><Input Value="@(editingUnitDeptName)" Disabled /></FormItem>
        @if (isEditingUnit) { <div class="mt-3 text-end"><Button Danger Type="ButtonType.Text" Icon="delete" OnClick="() => HandleDeleteUnit(editingUnit)">@locallizer["ลบกลุ่มงานนี้"]</Button></div> }
    </Form>
</Modal>

@* --- Modal 4: Manage Employees (จัดการบุคลากรในฝ่าย) --- *@
<Modal Title="@($"จัดการบุคลากร: {manageEmpDeptName}")"
       @bind-Visible="@_visibleManageEmps"
       Footer="null"
       Width="700">

    <div class="mb-3 d-flex justify-content-end">
        <Button Type="Primary" Icon="user-add" OnClick="() => NavigateToAddEmployee(manageEmpDept)">
            @locallizer["เพิ่มบุคลากรใหม่ในฝ่ายนี้"]
        </Button>
    </div>

    @* +++ แก้ไขบรรทัดนี้: เติม TItem="VEmployeeDetail" +++ *@
    <Table TItem="VEmployeeDetail" DataSource="@currentDeptEmps" PageSize="5" Size="TableSize.Small">

        @* คอลัมน์รูปภาพ *@
        <Column @bind-Field="@context.PictureUrl" Title="" Width="60">
            <Avatar Src="@(string.IsNullOrEmpty(context.PictureUrl) ? "/picture/user.png" : context.PictureUrl)" />
        </Column>

        @* คอลัมน์ชื่อ *@
        <Column Title="@locallizer["ชื่อ-นามสกุล"]" TData="string">
            @* สามารถใส่ TData="string" เพื่อความชัวร์ได้ *@
            <div class="fw-bold">@context.FirstNameThai @context.LastNameThai</div>
            <div class="text-muted" style="font-size: 0.8rem;">@context.EmployeeId</div>
        </Column>

        @* คอลัมน์ตำแหน่ง *@
        <Column Title="@locallizer["ตำแหน่ง"]" DataIndex="PositionId" TData="string" />

        @* คอลัมน์จัดการ *@
        <ActionColumn Title="@locallizer["จัดการ"]">
            <Space>
                <SpaceItem>
                    <Tooltip Title="@locallizer["แก้ไขข้อมูลส่วนตัว"]">
                        <Button Shape="@ButtonShape.Circle" Icon="edit" OnClick="() => NavigateToEditEmployee(context.EmployeeId)" />
                    </Tooltip>
                </SpaceItem>
                <SpaceItem>
                    <Tooltip Title="@locallizer["นำออกจากฝ่ายนี้ (Unassign)"]">
                        <Button Danger Shape="@ButtonShape.Circle" Icon="logout" OnClick="() => HandleUnassignEmployee(context)" />
                    </Tooltip>
                </SpaceItem>
            </Space>
        </ActionColumn>

    </Table>
</Modal>

<style>
    .dept-card { border-radius: 12px; transition: all 0.3s ease; }
    .dept-card:hover { transform: translateY(-5px); border-color: #1890ff; }
    .org-grid-wrapper { min-height: 400px; }
    .employee-section { min-height: 32px; transition: background 0.3s; }
    .employee-section:hover { background-color: #e6f7ff !important; }
    .unit-tag { cursor: pointer; transition: 0.2s; }
    .unit-tag:hover { opacity: 0.8; }
</style>
