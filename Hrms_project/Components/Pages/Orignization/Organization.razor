@page "/organization"
@rendermode InteractiveServer
@using Datamodels.Hrms
@using HrmsSolution.Service
@using AntDesign
@inject IOrganizationService OrganizationService
@inject MessageService MessageService

<PageTitle>โครงสร้างองค์กร</PageTitle>

<style>
    .org-chart-container {
        padding: 24px;
        background-color: #f8f9fa;
        overflow-x: auto;
        min-width: 900px;
    }

    .org-chart-header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 16px;
    }

    .org-chart-grid {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .division-row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .unit-tag {
        margin-right: 6px;
        margin-bottom: 6px;
    }

    .card-division {
        min-width: 300px;
        width: 320px;
    }

    .dept-card {
        margin-top: 8px;
    }

    .search-box {
        width: 320px;
    }
</style>

<div class="org-chart-container">
    <div class="org-chart-header">
        <h3 style="margin:0;">โครงสร้างองค์กร</h3>

        <div class="search-box">
            <AntDesign.Input Placeholder="ค้นหาชื่อสำนัก/กอง..."
                             Value="searchTerm"
                             ValueChanged="@((string v) => { searchTerm = v ?? string.Empty; ApplyFilter(); })" />
        </div>

        <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
            <Button Type="@ButtonType.Primary" OnClick="@LoadOrganizationData">รีเฟรช</Button>
            <Button Type="@ButtonType.Default" OnClick="@SeedSampleDataAsync">สร้างข้อมูลตัวอย่าง</Button>
        </div>
    </div>

    @if (isLoading)
    {
        <div style="text-align:center; padding:28px;">
            <Spin Size="@SpinSize.Large" />
        </div>
    }
    else if (filteredDivisions is null || !filteredDivisions.Any())
    {
        <div style="padding:16px;">
            ไม่พบข้อมูลสำนัก/กอง
            <div style="margin-top:8px;">
                <Button Type="@ButtonType.Primary" OnClick="@SeedSampleDataAsync">สร้างข้อมูลตัวอย่าง</Button>
            </div>
        </div>
    }
    else
    {
        <div class="org-chart-grid">
            @foreach (var division in filteredDivisions)
            {
                <Card Title="@(division.DivisionNameThai ?? division.DivisionNameEng)" Class="card-division">
                    <div>
                        <div style="font-size:0.9rem; color:#666; margin-bottom:8px;">
                            รหัส: @division.DivisionId
                        </div>

                        <div class="division-row">
                            @{
                                var depts = departments.Where(d => d.DivisionId == division.DivisionId).ToList();
                            }

                            @if (!depts.Any())
                            {
                                <div style="color:#999">ไม่มีฝ่าย/แผนก</div>
                            }
                            else
                            {
                                foreach (var dept in depts)
                                {
                                    <Card Size="@CardSize.Small" Title="@(dept.DeptNameThai ?? dept.DeptNameEng)" Class="dept-card">
                                        <div style="font-size:0.85rem; color:#666; margin-bottom:6px;">รหัส: @dept.DeptId</div>
                                        <div>
                                            @{
                                                var units = workUnits.Where(u => u.DeptId == dept.DeptId).ToList();
                                            }
                                            @if (!units.Any())
                                            {
                                                <div style="color:#999">ไม่มีหน่วย</div>
                                            }
                                            else
                                            {
                                                foreach (var u in units)
                                                {
                                                    <Tag Color="@TagColor.Blue" Class="unit-tag">@((u.UnitNameThai ?? u.UnitNameEng))</Tag>
                                                }
                                            }
                                        </div>
                                    </Card>
                                }
                            }
                        </div>
                    </div>
                </Card>
            }
        </div>
    }
</div>

@code {
    private bool isLoading = true;
    private string searchTerm = string.Empty;

    private List<Division> divisions = new();
    private List<Division> filteredDivisions = new();
    private List<Department> departments = new();
    private List<WorkUnit> workUnits = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadOrganizationData();
    }

    private async Task LoadOrganizationData()
    {
        try
        {
            isLoading = true;

            divisions = await OrganizationService.GetAllDivisionsAsync();
            departments.Clear();
            workUnits.Clear();

            // load departments and units for each division (sequential for simplicity)
            foreach (var div in divisions)
            {
                try
                {
                    var divDepts = await OrganizationService.GetDepartmentsByDivisionIdAsync(div.DivisionId);
                    if (divDepts != null && divDepts.Any())
                    {
                        departments.AddRange(divDepts);

                        foreach (var d in divDepts)
                        {
                            try
                            {
                                var deptUnits = await OrganizationService.GetWorkUnitsByDepartmentIdAsync(d.DeptId);
                                if (deptUnits != null && deptUnits.Any())
                                {
                                    workUnits.AddRange(deptUnits);
                                }
                            }
                            catch (Exception)
                            {
                                // ignore unit load errors for single dept to keep UI resilient
                            }
                        }
                    }
                }
                catch (Exception)
                {
                    // ignore department load errors per division
                }
            }

            ApplyFilter();
        }
        catch (Exception ex)
        {
            // MessageService.Error can be awaited but previously used without await - keep consistent
             MessageService.Error($"โหลดข้อมูลล้มเหลว: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task SeedSampleDataAsync()
    {
        if (divisions != null && divisions.Any())
        {
            MessageService.Info("มีข้อมูลอยู่แล้ว ไม่ต้องสร้างข้อมูลตัวอย่าง");
            return;
        }

        isLoading = true;
        try
        {
            // Define sample data
            var sampleDivisions = new List<Division>
            {
                new Division { DivisionId = "D001", DivisionNameThai = "สำนักทรัพยากรบุคคล", DivisionNameEng = "Human Resources", Isactive = "1" },
                new Division { DivisionId = "D002", DivisionNameThai = "สำนักการเงิน", DivisionNameEng = "Finance", Isactive = "1" }
            };

            var sampleDepartments = new List<Department>
            {
                new Department { DeptId = "DP001", DeptNameThai = "ฝ่ายสรรหา", DeptNameEng = "Recruitment", DivisionId = "D001", Isactive = "1" },
                new Department { DeptId = "DP002", DeptNameThai = "ฝ่ายพัฒนาบุคลากร", DeptNameEng = "Staff Development", DivisionId = "D001", Isactive = "1" },
                new Department { DeptId = "DP003", DeptNameThai = "ฝ่ายบัญชี", DeptNameEng = "Accounting", DivisionId = "D002", Isactive = "1" }
            };

            var sampleUnits = new List<WorkUnit>
            {
                new WorkUnit { UnitId = "U001", UnitNameThai = "หน่วยสรรหา 1", UnitNameEng = "Recruit Unit 1", DeptId = "DP001", Isactive = "1" },
                new WorkUnit { UnitId = "U002", UnitNameThai = "หน่วยฝึกอบรม", UnitNameEng = "Training Unit", DeptId = "DP002", Isactive = "1" },
                new WorkUnit { UnitId = "U003", UnitNameThai = "หน่วยบัญชี 1", UnitNameEng = "Accounting Unit 1", DeptId = "DP003", Isactive = "1" }
            };

            var anyCreatedOnServer = false;

            // Try to add via OrganizationService; if service fails, fall back to local lists
            foreach (var d in sampleDivisions)
            {
                try
                {
                    var ok = await OrganizationService.AddDivisionAsync(d);
                    anyCreatedOnServer = anyCreatedOnServer || ok;
                }
                catch
                {
                    // ignore and fallback later
                }
            }

            foreach (var dept in sampleDepartments)
            {
                try
                {
                    var ok = await OrganizationService.AddDepartmentAsync(dept);
                    anyCreatedOnServer = anyCreatedOnServer || ok;
                }
                catch
                {
                }
            }

            foreach (var u in sampleUnits)
            {
                try
                {
                    var ok = await OrganizationService.AddWorkUnitAsync(u);
                    anyCreatedOnServer = anyCreatedOnServer || ok;
                }
                catch
                {
                }
            }

            // If server calls didn't create anything (e.g., API unavailable), add locally so UI shows data
            if (!anyCreatedOnServer)
            {
                divisions.AddRange(sampleDivisions);
                departments.AddRange(sampleDepartments);
                workUnits.AddRange(sampleUnits);
                ApplyFilter();
            }
            else
            {
                // reload from server
                await LoadOrganizationData();
            }

             MessageService.Success("สร้างข้อมูลตัวอย่างเรียบร้อย");
        }
        catch (Exception ex)
        {
             MessageService.Error($"ไม่สามารถสร้างข้อมูลตัวอย่างได้: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void ApplyFilter()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            filteredDivisions = divisions.ToList();
            return;
        }

        var q = searchTerm.Trim();
        filteredDivisions = divisions.Where(d =>
            (d.DivisionNameThai?.Contains(q, StringComparison.OrdinalIgnoreCase) ?? false) ||
            (d.DivisionNameEng?.Contains(q, StringComparison.OrdinalIgnoreCase) ?? false) ||
            (d.DivisionId?.Contains(q, StringComparison.OrdinalIgnoreCase) ?? false)
        ).ToList();
    }
}