@page "/personnel"
@rendermode InteractiveServer
@using System.ComponentModel.DataAnnotations
@using Datamodels.Hrms
@using HrmsSolution.Service
@using AntDesign
@using static AntDesign.IconType
@inject IEmployeeService EmployeeService
@inject NavigationManager NavigationManager
@inject MessageService MessageService

<PageTitle>ข้อมูลบุคลากร</PageTitle>

<div class="personnel-container">
    <div class="page-header">
        <h4 class="page-title">ข้อมูลบุคลากร</h4>
    </div>

    <Card Class="content-card">
        <Row Gutter="16" Class="filter-section">
            <Col Span="6" XXL="4">
            <Search Placeholder="ค้นหาชื่อ-สกุล อีเมล"
                    @bind-Value="searchText"
                    OnSearch="ApplyFilter"
                    OnInput="ApplyFilter"
                    Style="width: 100%" />
            </Col>

            <Col Span="18" XXL="20" Style="text-align: right;">
            <Button Type="@ButtonType.Primary" OnClick="ShowAddModal" Style="background-color: #28a745; border-color: #28a745;">
                <Icon Type="@(Outline.PlusCircle)" /> เพิ่มบุคลากร
            </Button>
            </Col>
        </Row>

        <Row Gutter="16" Class="mt-3">
            <Col Span="4" XXL="3">
            <Select TItemValue="string" TItem="string"
                    @bind-Value="@filterFirstName"
                    Placeholder="ชื่อ-สกุล (ไทย)"
                    OnSelectedItemChanged="@((_) => ApplyFilter())"
                    Style="width: 100%">
                <SelectOptions>
                    <SelectOption TItemValue="string" TItem="string" Value="@ALL" Label="@ALL" />
                    <SelectOption TItemValue="string" TItem="string" Value="@SOMCHAI" Label="@SOMCHAI" />
                    <SelectOption TItemValue="string" TItem="string" Value="@WALLOP" Label="@WALLOP" />
                </SelectOptions>
            </Select>
            </Col>
            <Col Span="4" XXL="3">
            <Select TItemValue="string" TItem="string"
                    @bind-Value="@filterDivision1"
                    Placeholder="หน่วยงานระดับ 1"
                    OnSelectedItemChanged="@((_) => ApplyFilter())"
                    Style="width: 100%">
                <SelectOptions>
                    <SelectOption TItemValue="string" TItem="string" Value="@ALL" Label="@ALL" />
                    <SelectOption TItemValue="string" TItem="string" Value="@PSU" Label="@PSU" />
                </SelectOptions>
            </Select>
            </Col>
            <Col Span="4" XXL="3">
            <Select TItemValue="string" TItem="string"
                    @bind-Value="@filterDivision2"
                    Placeholder="หน่วยงานระดับ 2"
                    OnSelectedItemChanged="@((_) => ApplyFilter())"
                    Style="width: 100%">
                <SelectOptions>
                    <SelectOption TItemValue="string" TItem="string" Value="@ALL" Label="@ALL" />
                    <SelectOption TItemValue="string" TItem="string" Value="@FMS" Label="@FMS" />
                </SelectOptions>
            </Select>
            </Col>
            <Col Span="4" XXL="3">
            <Select TItemValue="string" TItem="string"
                    @bind-Value="@filterStatus"
                    Placeholder="จัดการสถานะ"
                    OnSelectedItemChanged="@((_) => ApplyFilter())"
                    Style="width: 100%">
                <SelectOptions>
                    <SelectOption TItemValue="string" TItem="string" Value="@ALL" Label="@ALL" />
                    <SelectOption TItemValue="string" TItem="string" Value="@ACTIVE" Label="กิจกรรม" />
                    <SelectOption TItemValue="string" TItem="string" Value="@INACTIVE" Label="ไม่กิจกรรม" />
                </SelectOptions>
            </Select>
            </Col>
        </Row>

        @if (!string.IsNullOrEmpty(errorMessage) && !showAddModal)
        {
            <Alert Message="เกิดข้อผิดพลาดในการโหลดข้อมูล"
                   Description="@errorMessage"
                   Type="@AlertType.Error"
                   ShowIcon="true"
                   Class="mt-3" />
        }

        <Table TItem="Employee"
               DataSource="@FilteredPersonnel"
               Size="@TableSize.Middle"
               Bordered
               Loading="@isLoading"
               Class="mt-4">
            <PropertyColumn Title="Employee ID" Property="c => c.EmployeeId"></PropertyColumn>
            <PropertyColumn Title="ชื่อ-สกุล (ไทย)" Property="c => c.FullNameThai"></PropertyColumn>
            <PropertyColumn Title="ชื่อ-สกุล (ENG)" Property="c => c.FullNameEng"></PropertyColumn>
            <PropertyColumn Title="อีเมล" Property="c => c.Email"></PropertyColumn>
            <PropertyColumn Title="หน่วยงานหลัก" Property="c => c.DivisionId"></PropertyColumn>
            <PropertyColumn Title="ตำแหน่ง" Property="c => c.PositionId"></PropertyColumn>

            <ActionColumn Title="สถานะ">
                <Space>
                    @{
                        bool isActive = context.EmploymentStatus == "กิจกรรม";
                    }
                    <Switch Checked="@isActive" OnChange="@(async isChecked => await ToggleStatus(context))" />
                    <Tag Color="@(isActive ? "blue" : "default")">@(isActive ? "กิจกรรม" : "ไม่กิจกรรม")</Tag>
                </Space>
            </ActionColumn>

            <ActionColumn Title="การจัดการ">
                <Space>
                    <Tooltip Title="ดูรายละเอียด">
                        <Button Size="@ButtonSize.Small"
                                OnClick="@(() => ViewDetails(context))"
                                Icon="@Outline.Eye"
                                Style="color: #17a2b8; border-color: #17a2b8;" />
                    </Tooltip>
                    <Tooltip Title="แก้ไข">
                        <Button Size="@ButtonSize.Small"
                                Type="@ButtonType.Default"
                                OnClick="@(() => EditPerson(context))"
                                Icon="@Outline.Edit"
                                Style="color: #ffc107; border-color: #ffc107;" />
                    </Tooltip>
                    <Tooltip Title="จัดการหน่วยงาน">
                        <Button Size="@ButtonSize.Small"
                                Type="@ButtonType.Default"
                                OnClick="@(() => ManageDivision(context))"
                                Icon="@Outline.Setting"
                                Style="color: #343a40; border-color: #343a40;" />
                    </Tooltip>
                    <Popconfirm Title="ยืนยันการลบ?"
                                OkText="ลบ"
                                CancelText="ยกเลิก"
                                OnConfirm="@(() => DeletePerson(context))">
                        <Button Size="@ButtonSize.Small"
                                Type="@ButtonType.Primary"
                                Danger
                                Icon="@Outline.Delete" />
                    </Popconfirm>
                </Space>
            </ActionColumn>
        </Table>

        <Row Class="pagination-section mt-3">
            <Col Span="24" Style="text-align: right;">
            <Pagination DefaultCurrent="1"
                        Total="140"
                        PageSize="10"
                        Size="@PaginationSize.Small"
                        ShowSizeChanger="true" />
            </Col>
        </Row>
    </Card>
</div>

<!-- Add Employee Modal -->
<Modal @bind-Visible="@showAddModal"
       Title="เพิ่มข้อมูลบุคลากรใหม่"
       OnCancel="HideAddModal"
       Width="800"
       Footer="null">

    <Form Model="@newEmployee"
          OnFinish="HandleAddEmployee"
          LabelColSpan="6"
          WrapperColSpan="18">

        <Alert Message="ข้อมูลที่กรอกในฟอร์มจะถูกส่งไปบันทึกผ่าน API"
               Type="@AlertType.Info"
               ShowIcon="true"
               Class="mb-4" />

        @if (!string.IsNullOrEmpty(modalError))
        {
            <Alert Message="เกิดข้อผิดพลาด"
                   Description="@modalError"
                   Type="@AlertType.Error"
                   ShowIcon="true"
                   Class="mb-3" />
        }
        @if (!string.IsNullOrEmpty(modalSuccess))
        {
            <Alert Message="บันทึกสำเร็จ"
                   Description="@modalSuccess"
                   Type="@AlertType.Success"
                   ShowIcon="true"
                   Class="mb-3" />
        }

        <Row Gutter="16">
            <Col Span="12">
            <FormItem Label="ชื่อ (ไทย)">
                <Input @bind-Value="newEmployee.FirstNameThai" Required />
            </FormItem>
            </Col>
            <Col Span="12">
            <FormItem Label="นามสกุล (ไทย)">
                <Input @bind-Value="newEmployee.LastNameThai" />
            </FormItem>
            </Col>
            <Col Span="12">
            <FormItem Label="First Name (Eng)">
                <Input @bind-Value="newEmployee.FirstNameEng" />
            </FormItem>
            </Col>
            <Col Span="12">
            <FormItem Label="Last Name (Eng)">
                <Input @bind-Value="newEmployee.LastNameEng" />
            </FormItem>
            </Col>
            <Col Span="24">
            <FormItem Label="อีเมล" LabelColSpan="3" WrapperColSpan="21">
                <Input @bind-Value="newEmployee.Email" Required Type="@InputType.Email" />
            </FormItem>
            </Col>
            <Col Span="12">
            <FormItem Label="Division ID">
                <Input @bind-Value="newEmployee.DivisionId" />
            </FormItem>
            </Col>
            <Col Span="12">
            <FormItem Label="Position ID">
                <Input @bind-Value="newEmployee.PositionId" />
            </FormItem>
            </Col>
        </Row>

        <FormItem WrapperColOffset="6">
            <Space Style="margin-top: 16px;">
                <Button OnClick="HideAddModal">ยกเลิก</Button>
                <Button Type="@ButtonType.Primary" HtmlType="submit">
                    <Icon Type="@(Outline.Save)" /> บันทึกบุคลากร
                </Button>
            </Space>
        </FormItem>
    </Form>
</Modal>

<style>
    .personnel-container {
        background: #f0f2f5;
        min-height: 100vh;
        padding: 20px;
    }

    .page-title {
        margin: 0;
        font-size: 24px;
        font-weight: 600;
        color: #333;
    }

    .page-header {
        background: white;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .content-card {
        border-radius: 8px !important;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

        .content-card .ant-card-body {
            padding: 20px !important;
        }

    .filter-section {
        margin-bottom: 16px;
    }

    .pagination-section {
        border-top: 1px solid #f0f0f0;
        padding-top: 16px;
        margin-top: 16px;
    }

    /* Button hover effects */
    .ant-btn:hover {
        opacity: 0.8;
        transform: translateY(-1px);
        transition: all 0.2s;
    }
</style>

@code {
    private List<Employee> personnel = new();
    private bool isLoading = true;

    // Constants for select options
    private const string ALL = "ทั้งหมด";
    private const string SOMCHAI = "สมชาย";
    private const string WALLOP = "วัลลภ";
    private const string PSU = "มหาวิทยาลัยสงขลานครินทร์";
    private const string FMS = "คณะวิทยาการจัดการ";
    private const string ACTIVE = "Active";
    private const string INACTIVE = "Inactive";

    // Filter parameters
    private string searchText = "";
    private string filterFirstName = "";
    private string filterDivision1 = "";
    private string filterDivision2 = "";
    private string filterStatus = "";

    // Modal state
    private bool showAddModal = false;
    private Employee newEmployee = new();
    private string errorMessage = "";
    private string modalError = "";
    private string modalSuccess = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadPersonnel();
    }

    private async Task LoadPersonnel()
    {
        isLoading = true;
        errorMessage = "";
        try
        {
            personnel = await EmployeeService.GetAllEmployeesAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"ไม่สามารถดึงข้อมูลบุคลากรจาก API ได้ ({ex.Message})";
            personnel = new List<Employee>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ApplyFilter()
    {
        StateHasChanged();
    }

    private IEnumerable<Employee> FilteredPersonnel
    {
        get
        {
            var filtered = personnel.AsEnumerable();

            if (!string.IsNullOrWhiteSpace(searchText))
            {
                filtered = filtered.Where(p =>
                    (p.FullNameThai?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (p.FullNameEng?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (p.Email?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false));
            }

            if (!string.IsNullOrWhiteSpace(filterFirstName))
            {
                filtered = filtered.Where(p => p.FirstNameThai?.Contains(filterFirstName, StringComparison.OrdinalIgnoreCase) ?? false);
            }

            if (!string.IsNullOrWhiteSpace(filterDivision1))
            {
                filtered = filtered.Where(p => p.DivisionId?.Contains(filterDivision1, StringComparison.OrdinalIgnoreCase) ?? false);
            }

            if (!string.IsNullOrWhiteSpace(filterStatus))
            {
                string requiredStatus = filterStatus == "Active" ? "กิจกรรม" : "ไม่กิจกรรม";
                filtered = filtered.Where(p => p.EmploymentStatus == requiredStatus);
            }

            return filtered;
        }
    }

    private void ShowAddModal()
    {
        newEmployee = new Employee();
        showAddModal = true;
        modalError = "";
        modalSuccess = "";
    }

    private void HideAddModal()
    {
        showAddModal = false;
    }

    private async Task HandleAddEmployee()
    {
        modalError = "";
        modalSuccess = "";

        if (string.IsNullOrWhiteSpace(newEmployee.FirstNameThai) || string.IsNullOrWhiteSpace(newEmployee.Email))
        {
            modalError = "กรุณากรอกชื่อ (ภาษาไทย) และอีเมลให้ครบถ้วน";
            return;
        }

        try
        {
            newEmployee.EmployeeId = Guid.NewGuid().ToString();
            newEmployee.FullNameThai = $"{newEmployee.FirstNameThai} {newEmployee.LastNameThai}".Trim();
            newEmployee.FullNameEng = $"{newEmployee.FirstNameEng} {newEmployee.LastNameEng}".Trim();
            newEmployee.EmploymentStatus = "กิจกรรม";

            var addedEmployee = await EmployeeService.AddEmployeeAsync(newEmployee);

            modalSuccess = $"เพิ่มบุคลากร {addedEmployee.FullNameThai} สำเร็จแล้ว!";
            MessageService.Success($"บันทึกบุคลากร {addedEmployee.FullNameThai} สำเร็จ");

            await LoadPersonnel();
        }
        catch (Exception ex)
        {
            modalError = $"ไม่สามารถเพิ่มบุคลากรได้: {ex.Message}";
            MessageService.Error($"เกิดข้อผิดพลาดในการบันทึก: {ex.Message}");
        }
    }

    private async Task ToggleStatus(Employee person)
    {
        string newStatus = person.EmploymentStatus == "กิจกรรม" ? "ไม่กิจกรรม" : "กิจกรรม";
        string oldStatus = person.EmploymentStatus ?? "ไม่กิจกรรม";
        person.EmploymentStatus = newStatus;

        try
        {
            await EmployeeService.UpdateEmployeeAsync(person.EmployeeId, person);
            MessageService.Success($"อัปเดตสถานะ {person.EmployeeId} เป็น {newStatus} สำเร็จ");
        }
        catch (Exception ex)
        {
            MessageService.Error($"ไม่สามารถอัปเดตสถานะได้: {ex.Message}");
            person.EmploymentStatus = oldStatus;
        }
    }

    private void ViewDetails(Employee person)
    {
        NavigationManager.NavigateTo($"/personnel/{person.EmployeeId}");
    }

    private void EditPerson(Employee person)
    {
        NavigationManager.NavigateTo($"/personnel/edit/{person.EmployeeId}");
    }

    private void ManageDivision(Employee person)
    {
        NavigationManager.NavigateTo($"/personnel/{person.EmployeeId}/divisions");
    }

    private async Task DeletePerson(Employee person)
    {
        try
        {
            await EmployeeService.DeleteEmployeeAsync(person.EmployeeId);
            await LoadPersonnel();
            MessageService.Success($"ลบข้อมูลบุคลากร {person.EmployeeId} สำเร็จ");
        }
        catch (Exception ex)
        {
            MessageService.Error($"ไม่สามารถลบข้อมูลบุคลากร: {ex.Message}");
        }
    }
}