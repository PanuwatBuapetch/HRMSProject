@page "/locations"
@using Datamodels.Hrms
@using HrmsSolution.Service
@using AntDesign
@using CurrieTechnologies.Razor.SweetAlert2

@inject ILocationService LocationService
@inject SweetAlertService Swal

<h1>ข้อมูลที่ตั้ง/สาขา</h1>
<hr />

<Table DataSource="@locations" Loading="@isLoading">
    <Column @bind-Field="@context.LocationId" Title="รหัส" Sortable />
    <Column @bind-Field="@context.LocationNameThai" Title="ชื่อ (ไทย)" Sortable />
    <Column @bind-Field="@context.LocationNameEng" Title="ชื่อ (อังกฤษ)" Sortable />

    <ActionColumn Title="จัดการ">
        <Space>
            <SpaceItem>
                <Button Type="ButtonType.Primary" OnClick="() => OnEdit(context)">แก้ไข</Button>
            </SpaceItem>
            <SpaceItem>
                <Button Danger OnClick="() => OnDelete(context)">ลบ</Button>
            </SpaceItem>
        </Space>
    </ActionColumn>
</Table>


@code {
    private List<Location> locations;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            locations = await LocationService.GetAllLocationsAsync();
        }
        catch (Exception ex)
        {
            await Swal.FireAsync(
                "เกิดข้อผิดพลาด",
                $"ไม่สามารถโหลดข้อมูลได้: {ex.Message}",
                SweetAlertIcon.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    // (แก้ไข) เปลี่ยนจาก void เป็น Task
    private Task OnEdit(Location item)
    {
        // (Logic การแก้ไข)
        // (เช่น NavigationManager.NavigateTo($"/location/edit/{item.LocationId}"))

        return Task.CompletedTask; // (สำคัญ) คืนค่า Task ที่เสร็จแล้ว
    }

    private async Task OnDelete(Location item)
    {
        var result = await Swal.FireAsync(new SweetAlertOptions
        {
            Title = "ยืนยันการลบ",
            Text = $"คุณต้องการลบ {item.LocationNameThai}?",
            Icon = SweetAlertIcon.Warning,
            ShowCancelButton = true,
            ConfirmButtonText = "ตกลง",
            CancelButtonText = "ยกเลิก"
        });

        if (result.IsConfirmed)
        {
            try
            {
                var deleteSuccess = await LocationService.DeleteLocationAsync(item.LocationId);

                if (deleteSuccess)
                {
                    locations.Remove(item);
                    await Swal.FireAsync("สำเร็จ!", "ข้อมูลถูกลบแล้ว", SweetAlertIcon.Success);
                }
                else
                {
                    await Swal.FireAsync("ผิดพลาด", "ไม่สามารถลบข้อมูลได้", SweetAlertIcon.Error);
                }
            }
            catch (Exception ex)
            {
                await Swal.FireAsync("ผิดพลาด", ex.Message, SweetAlertIcon.Error);
            }
        }
    }
}