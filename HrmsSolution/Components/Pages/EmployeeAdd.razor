@page "/addemployee"
@using Datamodels.Hrms
@using HrmsSolution.Service
@using AntDesign
@using CurrieTechnologies.Razor.SweetAlert2
@using Microsoft.Extensions.Localization

@inject IEmployeeService EmployeeService
@inject ILocationService LocationService
@inject IDivisionService DivisionService
@inject IDepartmentService DepartmentService
@inject IJobPositionService JobPositionService
@inject IEmployeeTitleService EmployeeTitleService
@inject NavigationManager NavManager
@inject SweetAlertService Swal

<h1>เพิ่มพนักงานใหม่</h1>
<hr />

<Form Model="@newEmployee" OnFinish="HandleSubmit" LabelColSpan="8" WrapperColSpan="16" Loading="@isLoading">
    <Row Gutter="24">
        <Col Span="12">
        <FormItem Label="รหัสพนักงาน">
            <Input @bind-Value="@newEmployee.EmployeeId" />
        </FormItem>
        <FormItem Label="ชื่อ (ไทย)">
            <Input @bind-Value="@newEmployee.FirstNameThai" />
        </FormItem>
        <FormItem Label="นามสกุล (ไทย)">
            <Input @bind-Value="@newEmployee.LastNameThai" />
        </FormItem>
        <FormItem Label="อีเมล">
            <Input @bind-Value="@newEmployee.Email" />
        </FormItem>
        <FormItem Label="คำนำหน้าชื่อ">
            <Select DataSource="@titles" @bind-Value="@newEmployee.TitleId" TextField="TitleNameThai" ValueField="TitleId" AllowClear />
        </FormItem>
        </Col>
        <Col Span="12">
        <FormItem Label="ตำแหน่งงาน">
            <Select DataSource="@positions" @bind-Value="@newEmployee.PositionId" TextField="PositionNameThai" ValueField="PositionId" AllowClear />
        </FormItem>
        <FormItem Label="ที่ตั้ง/สาขา">
            <Select DataSource="@locations" @bind-Value="@newEmployee.LocationId" TextField="LocationNameThai" ValueField="LocationId" AllowClear />
        </FormItem>
        <FormItem Label="ฝ่าย/สายงาน">
            <Select DataSource="@divisions" @bind-Value="@newEmployee.DivisionId" TextField="DivisionNameThai" ValueField="DivisionId" AllowClear />
        </FormItem>
        <FormItem Label="แผนก">
            <Select DataSource="@departments" @bind-Value="@newEmployee.DeptId" TextField="DeptNameThai" ValueField="DeptId" AllowClear />
        </FormItem>
        </Col>
    </Row>
    <Row>
        <FormItem>
            <Button Type="ButtonType.Primary" HtmlType="submit">บันทึกข้อมูล</Button>

            <Button OnClick="@(() => NavManager.NavigateTo("/employees"))" Style="margin-left: 8px;">ยกเลิก</Button>

        </FormItem>
    </Row>
</Form>


@code {
    // 3. Model หลักสำหรับผูกฟอร์ม
    private Employee newEmployee = new Employee();
    private bool isLoading = true;

    // 4. Lists สำหรับเก็บข้อมูล Dropdown ทั้งหมด
    private List<EmployeeTitle> titles = new List<EmployeeTitle>();
    private List<JobPosition> positions = new List<JobPosition>();
    private List<Location> locations = new List<Location>();
    private List<Division> divisions = new List<Division>();
    private List<Department> departments = new List<Department>();

    // 5. โหลดข้อมูล Dropdown ทั้งหมดเมื่อหน้าเว็บเริ่มทำงาน
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // ใช้ Task.WhenAll เพื่อโหลดทุกอย่างพร้อมกัน
            await Task.WhenAll(
                LoadTitles(),
                LoadPositions(),
                LoadLocations(),
                LoadDivisions(),
                LoadDepartments()
            );
        }
        catch (Exception ex)
        {
            await Swal.FireAsync("เกิดข้อผิดพลาด", $"ไม่สามารถโหลดข้อมูลพื้นฐานได้: {ex.Message}", SweetAlertIcon.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    // (เมธอดช่วยโหลดข้อมูล)
    private async Task LoadTitles() { titles = await EmployeeTitleService.GetAllEmployeeTitlesAsync(); }
    private async Task LoadPositions() { positions = await JobPositionService.GetAllJobPositionsAsync(); }
    private async Task LoadLocations() { locations = await LocationService.GetAllLocationsAsync(); }
    private async Task LoadDivisions() { divisions = await DivisionService.GetAllDivisionsAsync(); }
    private async Task LoadDepartments() { departments = await DepartmentService.GetAllDepartmentsAsync(); }


    // 6. เมธอดเมื่อกดปุ่ม "บันทึกข้อมูล" (OnFinish)
    private async Task HandleSubmit()
    {
        try
        {
            isLoading = true;
            // เรียก Service เพื่อ "Add" ข้อมูลผ่าน API
            var createdEmployee = await EmployeeService.AddEmployeeAsync(newEmployee);

            isLoading = false;

            // แสดงผลว่าสำเร็จ
            await Swal.FireAsync("บันทึกสำเร็จ!", $"เพิ่มพนักงาน {createdEmployee.FirstNameThai} เรียบร้อยแล้ว", SweetAlertIcon.Success);

            // ย้ายกลับไปหน้า List
            NavManager.NavigateTo("/employees");
        }
        catch (Exception ex)
        {
            isLoading = false;
            await Swal.FireAsync("เกิดข้อผิดพลาด", $"ไม่สามารถบันทึกข้อมูลได้: {ex.Message}", SweetAlertIcon.Error);
        }
    }
}